/**
 * Copyright (c) 2013 by Appcelerator, Inc. All Rights Reserved.
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 *
 * This generated code and related technologies are covered by patents
 * or patents pending by Appcelerator, Inc.
 */

// WARNING: this file is generated and will be overwritten
// Generated on <%=new Date%>

#define UNUSED(x) (void)(x)

/**
 * JSC implementation for <%=entry.framework%>/<%=entry.name%>
 */
<%
	var readonly_properties = {},
		readwrite_properties = {},
        methods = {},
        properties_to_exclude = exclusions.properties,
        methods_to_exclude = exclusions.methods,
        varname = entry.name.toLowerCase();

    copyProperties(true,entry.properties,properties_to_exclude,methods_to_exclude,readonly_properties,readwrite_properties,imports,version,entry);
    copyMethods(true,entry.methods,methods,readonly_properties,readwrite_properties,methods_to_exclude,imports,version,entry);

    var superClass = metadata.classes[entry.superClass];
    if (superClass && externs.indexOf(entry.superClass)===-1) {
        externs.push(entry.superClass);
    }

    entry.protocols && entry.protocols.forEach(function(p){
        var pe = metadata.protocols[p];
        if (pe.framework && imports.indexOf(pe.framework)===-1) {
            imports.push(pe.framework);
        }
        copyMethods(true,pe.methods,methods,readonly_properties,readwrite_properties,methods_to_exclude,imports,version,entry);
        copyProperties(true,pe.properties,properties_to_exclude,methods_to_exclude,readonly_properties,readwrite_properties,imports,version,entry);
    });

    Object.keys(readonly_properties).forEach(function(k){
        delete readwrite_properties[k];
    });

-%>
#import "<%=entry.name%>.h"

static JSClassRef ctorClassRef;

<% Object.keys(readonly_properties).sort().forEach(function(p) { 
    var property = readonly_properties[p];
-%>
/**
 * [<%=entry.name%> <%=p%>]
 */
JSValueRef Get<%=: p | capitalize %>For<%=entry.name%> (JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
    <%-generateReturnType(property.type,property.subtype,'prop',entry.name)%> = <%=varname%>.<%=p%>;
    UNUSED(prop);
    <%-generateJSCType(metadata,externs,makers,entry.name,property.type,property.subtype,'prop','result','    ',imports) %>
    return result;
}

<% }) -%>

<% Object.keys(readwrite_properties).sort().forEach(function(p) { 
    var property = readwrite_properties[p],
        classtype = getClassType(metadata,property.type,property.subtype,entry.name,varname);
-%>
/**
 * [<%=entry.name%> <%=p%>]
 */
JSValueRef Get<%=: p | capitalize %>For<%=entry.name%> (JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
    <%-generateReturnType(property.type,property.subtype,'prop',entry.name)%> = <%=varname%>.<%=p%>;
    UNUSED(prop);
    <%-generateJSCType(metadata,externs,makers,entry.name,property.type,property.subtype,'prop','result','    ',imports) %>
    return result;
}

/**
 * [<%=entry.name%> <%=p%>:value]
 */
bool Set<%=: p | capitalize %>For<%=entry.name%> (JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
    UNUSED(<%=varname%>);

    NSLog(@"set <%=p%>");

    if (JSValueIsObject(ctx,value)) 
    {
<% if (classtype.metatype === 'interface') { -%>
        JSObjectRef vo = JSValueToObject(ctx,value,exception);
        <%-property.type%> v = (<%-property.type%>)HyperloopGetPrivateObjectAsID(vo);
        NSLog(@"v returned %@",v);
        <%=varname%>.<%=p%> = v;
<% } else if (classtype.metatype === 'primitive') { -%>
        double v = JSValueToNumber(ctx,value,exception);
        <%=varname%>.<%=p%> = (<%-property.type%>)v;
<% } else if (classtype.metatype === 'enum') { -%>
        double v = JSValueToNumber(ctx,value,exception);
        <%=varname%>.<%=p%> = (<%-property.type%>)v;
<% } else if (classtype.metatype === 'struct') { -%>
        <%-structFromObject(metadata,classtype,'value','value$','        ')%>
        <%=varname%>.<%=p%> = value$;
<% } %>
    }
    return true;
}
<% }) -%>

<% Object.keys(methods).sort().forEach(function(m) { 
    var ma = methods[m];
-%>
/**
 * [<%=entry.name%> <%=ma[0].selector%>]
 */
JSValueRef <%=m%>For<%=entry.name%> (JSContextRef ctx, JSObjectRef function, JSObjectRef object, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
<% ma.forEach(function(method) { -%>
    // <%-method.selector%>
    if (argumentCount == <%=method.args.length%>) 
    {
        <%-generateInvocation(metadata,externs,makers,entry,method,varname,m,'        ',true,imports)%>
    }
<% });-%>
    <%-makeException('    ','invalid number of arguments passed') %>
}

<% });-%>

/**
 * generic conversion from native object representation to JS string
 */
JSValueRef toStringFor<%=entry.name%> (JSContextRef ctx, JSObjectRef function, JSObjectRef object, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
    return HyperloopToString(ctx, <%=varname%>);
}

static JSStaticValue StaticValueArrayFor<%=entry.name%> [] = {
<% Object.keys(readonly_properties).sort().forEach(function(p) { -%>
    { "<%=p%>", Get<%=: p | capitalize %>For<%=entry.name%>, 0, kJSPropertyAttributeReadOnly },
<% }) -%>
<% Object.keys(readwrite_properties).sort().forEach(function(p) { -%>
    { "<%=p%>", Get<%=: p | capitalize %>For<%=entry.name%>, Set<%=: p | capitalize %>For<%=entry.name%>, kJSPropertyAttributeNone },
<% }) -%>
    { 0, 0, 0, 0 }
};

static JSStaticFunction StaticFunctionArrayFor<%=entry.name%> [] = {
<% Object.keys(methods).sort().forEach(function(m) {  -%>
    { "<%=m%>", <%=m%>For<%=entry.name%>, kJSPropertyAttributeNone },
<% }) -%>
    { "toString", toStringFor<%=entry.name%>, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontEnum | kJSPropertyAttributeDontDelete },
    { 0, 0, 0 }
};

/**
 * called when a new JS object is created for this class
 */
void InitializerFor<%=entry.name%> (JSContextRef ctx, JSObjectRef object)
{
}

/**
 * called when the JS object is ready to be garbage collected
 */
void FinalizerFor<%=entry.name%> (JSObjectRef object)
{
    HyperloopDestroyPrivateObject(object);
}

/**
 * type conversion from native type to JS type
 */
JSValueRef JSTypeConvertorFor<%=entry.name%>(JSContextRef ctx, JSObjectRef object, JSType type, JSValueRef* exception)
{
    <%-entry.name%> *<%=varname%> = (<%=entry.name%>*)HyperloopGetPrivateObjectAsID(object);
    if (type == kJSTypeString) 
    {
        NSString *description = [<%=varname%> description];
        JSStringRef descriptionStr = JSStringCreateWithUTF8CString([description UTF8String]);
        JSValueRef result = JSValueMakeString(ctx, descriptionStr);
        JSStringRelease(descriptionStr);
        return result;
    }
    else 
    {
        double value = 0;
        if ([<%=varname%> isKindOfClass:[NSNumber class]]) 
        {
            value = [((NSNumber*)<%=varname%>) doubleValue];
        }
        else
        {
            NSString *description = [<%=varname%> description];
            NSNumberFormatter *numberFormatter = [[NSNumberFormatter alloc] init];
            [numberFormatter setNumberStyle:NSNumberFormatterDecimalStyle];
            value = [[numberFormatter numberFromString:description] doubleValue];
            [numberFormatter release];
        }
        return JSValueMakeNumber(ctx, value);
    }
    return NULL;
}

/**
 * called to get the JSClassRef for <%=entry.name%> class
 */
JSClassRef CreateClassFor<%=entry.name%> ()
{
    static bool init;
    if (!init) 
    {
        init = true;
    
        JSClassDefinition ctorClassDefRef = kJSClassDefinitionEmpty;
        ctorClassDefRef.className = "<%=entry.name%>ClassConstructor";
        ctorClassDefRef.callAsConstructor = MakeInstanceFor<%=entry.name%>Class;
        ctorClassRef = JSClassCreate(&ctorClassDefRef);

        ClassDefinitionFor<%=entry.name%> = kJSClassDefinitionEmpty;
        ClassDefinitionFor<%=entry.name%>.staticValues = StaticValueArrayFor<%=entry.name%>;
        ClassDefinitionFor<%=entry.name%>.staticFunctions = StaticFunctionArrayFor<%=entry.name%>;
        ClassDefinitionFor<%=entry.name%>.initialize = InitializerFor<%=entry.name%>;
        ClassDefinitionFor<%=entry.name%>.finalize = FinalizerFor<%=entry.name%>;
        ClassDefinitionFor<%=entry.name%>.convertToType = JSTypeConvertorFor<%=entry.name%>;
        ClassDefinitionFor<%=entry.name%>.className = "<%=entry.name%>";

    <% if (entry.superClass) { -%>
    ClassDefinitionFor<%=entry.name%>.parentClass = <%=entry.superClass%>ClassDef;
    <% } -%>
    <%=entry.name%>ClassDef = JSClassCreate(&ClassDefinitionFor<%=entry.name%>);

        JSClassRetain(<%=entry.name%>ClassDef);
        
        // register the class definition so we can look it up by name
        RegisterJSObjectMakerForType(@"<%=entry.name%>",MakeObjectFor<%=entry.name%>);
    }
    return <%=entry.name%>ClassDef;
}

/**
 * called to make a native object for <%=entry.name%>. this method must be called instead of 
 * normal JSObjectMake in JavaScriptCore so that the correct prototype chain and 
 * constructor will be setup.
 */
JSObjectRef MakeObjectFor<%=entry.name%> (JSContextRef ctx, <%=entry.name%> *instance) 
{
    JSClassRef classRef = CreateClassFor<%=entry.name%>();
    JSObjectRef object = JSObjectMake(ctx, classRef, (void*)HyperloopMakePrivateObjectForID(instance));
    JSObjectRef value = JSObjectMake(ctx,ctorClassRef,0);

<% if (entry.superClass){ %>
    JSValueRef prototype = JSObjectGetPrototype(ctx, object);
    JSObjectRef prototypeRef = JSValueToObject(ctx, prototype, 0);
    JSObjectRef newPrototype = MakeObjectFor<%=entry.superClass%>(ctx,instance);
    JSStringRef protoProperty = JSStringCreateWithUTF8CString("__proto__");
    JSValueRef newP = JSObjectGetProperty(ctx, newPrototype, protoProperty, 0);
    JSObjectSetPrototype(ctx, prototypeRef, newP);
    JSStringRelease(protoProperty);
<% } %>

    JSStringRef cproperty = JSStringCreateWithUTF8CString("constructor");
    JSObjectSetProperty(ctx, object, cproperty, value, kJSPropertyAttributeDontEnum, 0);
    JSStringRelease(cproperty);

    return object;
}
